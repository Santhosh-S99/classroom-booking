<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Debug Tool - Classroom Booking System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .debug-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            background: #f8f9fa;
        }
        
        .section h3 {
            color: #ff6b35;
            margin-bottom: 15px;
        }
        
        .test-result {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25);
        }
        
        .button {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .button.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .button.info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .console-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        
        .config-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .step-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #ff6b35;
        }
        
        .step-number {
            background: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .alternatives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .alternative-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .alternative-card:hover {
            border-color: #ff6b35;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .alternative-card h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .pros, .cons {
            font-size: 0.9em;
        }
        
        .pros h5 {
            color: #28a745;
            margin-bottom: 8px;
        }
        
        .cons h5 {
            color: #dc3545;
            margin-bottom: 8px;
        }
        
        .pros ul, .cons ul {
            margin: 0;
            padding-left: 20px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://smtpjs.com/v3/smtp.js"></script>
</head>
<body>
    <div class="debug-container">
        <div class="header">
            <h1><i class="fas fa-envelope-open-text"></i> Email Debug Tool</h1>
            <p>Diagnose and fix email notification issues</p>
        </div>

        <!-- Current Configuration Check -->
        <div class="section">
            <h3><i class="fas fa-cog"></i> Current Configuration Check</h3>
            <div id="configStatus">
                <div class="test-result info">
                    <strong>Checking configuration...</strong>
                </div>
            </div>
            <button class="button" onclick="checkCurrentConfig()">
                <i class="fas fa-search"></i> Check Current Config
            </button>
            <div id="configDisplay" class="config-display" style="display: none;"></div>
        </div>

        <!-- Gmail Settings Verification -->
        <div class="section">
            <h3><i class="fab fa-google"></i> Gmail Settings Verification</h3>
            <div class="step-item">
                <div class="step-number">1</div>
                <div>
                    <strong>2-Factor Authentication Status:</strong>
                    <p>Verify 2FA is enabled on your Gmail account</p>
                    <button class="button info" onclick="window.open('https://myaccount.google.com/security', '_blank')">
                        <i class="fas fa-external-link-alt"></i> Check 2FA Status
                    </button>
                </div>
            </div>
            
            <div class="step-item">
                <div class="step-number">2</div>
                <div>
                    <strong>App Password Generation:</strong>
                    <p>Create a new app password specifically for this application</p>
                    <button class="button info" onclick="window.open('https://myaccount.google.com/apppasswords', '_blank')">
                        <i class="fas fa-key"></i> Generate App Password
                    </button>
                </div>
            </div>

            <div class="step-item">
                <div class="step-number">3</div>
                <div>
                    <strong>Less Secure Apps:</strong>
                    <p>Ensure "Less secure app access" is turned OFF (this is correct when using app passwords)</p>
                    <button class="button info" onclick="window.open('https://myaccount.google.com/lesssecureapps', '_blank')">
                        <i class="fas fa-shield-alt"></i> Check Security Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Email Test Form -->
        <div class="section">
            <h3><i class="fas fa-paper-plane"></i> Email Test</h3>
            <div class="form-group">
                <label for="testGmailUser">Gmail Address:</label>
                <input type="email" id="testGmailUser" placeholder="your-email@gmail.com">
            </div>
            
            <div class="form-group">
                <label for="testAppPassword">App Password (16 characters):</label>
                <input type="password" id="testAppPassword" placeholder="xxxx xxxx xxxx xxxx" maxlength="19">
                <small style="color: #6c757d;">Enter your Gmail app password (include spaces if shown with spaces)</small>
            </div>
            
            <div class="form-group">
                <label for="testToEmail">Send Test Email To:</label>
                <input type="email" id="testToEmail" placeholder="recipient@example.com">
            </div>
            
            <button class="button success" onclick="testEmailWithCredentials()">
                <i class="fas fa-envelope"></i> Send Test Email
            </button>
            
            <button class="button" onclick="testEmailWithCurrentConfig()">
                <i class="fas fa-cogs"></i> Test with Current Config
            </button>
            
            <div id="emailTestResult"></div>
        </div>

        <!-- Alternative Email Solutions -->
        <div class="section">
            <h3><i class="fas fa-alternatives"></i> Alternative Email Solutions</h3>
            <p>If SMTP.js continues to have issues, here are reliable alternatives:</p>
            
            <div class="alternatives-grid">
                <!-- EmailJS -->
                <div class="alternative-card">
                    <h4><i class="fas fa-rocket"></i> EmailJS (Recommended)</h4>
                    <p>Professional email service designed for web applications</p>
                    <div class="pros-cons">
                        <div class="pros">
                            <h5>✅ Pros:</h5>
                            <ul>
                                <li>Very reliable</li>
                                <li>No server required</li>
                                <li>Free tier available</li>
                                <li>Great documentation</li>
                            </ul>
                        </div>
                        <div class="cons">
                            <h5>❌ Cons:</h5>
                            <ul>
                                <li>Requires signup</li>
                                <li>Limited free emails</li>
                            </ul>
                        </div>
                    </div>
                    <button class="button success" onclick="setupEmailJS()">
                        <i class="fas fa-setup"></i> Setup EmailJS
                    </button>
                </div>

                <!-- Formspree -->
                <div class="alternative-card">
                    <h4><i class="fas fa-paper-plane"></i> Formspree</h4>
                    <p>Simple form-to-email service</p>
                    <div class="pros-cons">
                        <div class="pros">
                            <h5>✅ Pros:</h5>
                            <ul>
                                <li>Very easy setup</li>
                                <li>No coding required</li>
                                <li>Free tier</li>
                            </ul>
                        </div>
                        <div class="cons">
                            <h5>❌ Cons:</h5>
                            <ul>
                                <li>Less customization</li>
                                <li>Form-based only</li>
                            </ul>
                        </div>
                    </div>
                    <button class="button info" onclick="window.open('https://formspree.io/', '_blank')">
                        <i class="fas fa-external-link-alt"></i> Visit Formspree
                    </button>
                </div>

                <!-- Webhook -->
                <div class="alternative-card">
                    <h4><i class="fas fa-webhook"></i> Webhook Solution</h4>
                    <p>Use Firebase Functions or similar webhook service</p>
                    <div class="pros-cons">
                        <div class="pros">
                            <h5>✅ Pros:</h5>
                            <ul>
                                <li>Very reliable</li>
                                <li>Server-side security</li>
                                <li>Unlimited emails</li>
                            </ul>
                        </div>
                        <div class="cons">
                            <h5>❌ Cons:</h5>
                            <ul>
                                <li>Requires server setup</li>
                                <li>More complex</li>
                            </ul>
                        </div>
                    </div>
                    <button class="button" onclick="showWebhookGuide()">
                        <i class="fas fa-info"></i> Show Guide
                    </button>
                </div>

                <!-- Disable Emails -->
                <div class="alternative-card">
                    <h4><i class="fas fa-bell-slash"></i> Disable Email Notifications</h4>
                    <p>Temporarily disable email notifications while keeping other features</p>
                    <div class="pros-cons">
                        <div class="pros">
                            <h5>✅ Pros:</h5>
                            <ul>
                                <li>System works normally</li>
                                <li>No email errors</li>
                                <li>Easy to implement</li>
                            </ul>
                        </div>
                        <div class="cons">
                            <h5>❌ Cons:</h5>
                            <ul>
                                <li>No notifications</li>
                                <li>Teachers won't get alerts</li>
                            </ul>
                        </div>
                    </div>
                    <button class="button" onclick="generateNoEmailVersion()">
                        <i class="fas fa-download"></i> Generate Version
                    </button>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="section">
            <h3><i class="fas fa-terminal"></i> Debug Console</h3>
            <div id="debugConsole" class="console-output">
                Email debug console initialized...\n
            </div>
            <button class="button" onclick="clearConsole()">
                <i class="fas fa-trash"></i> Clear Console
            </button>
            <button class="button info" onclick="exportDebugLog()">
                <i class="fas fa-download"></i> Export Debug Log
            </button>
        </div>
    </div>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            
            const console = document.getElementById('debugConsole');
            console.textContent += logEntry + '\n';
            console.scrollTop = console.scrollHeight;
        }

        function checkCurrentConfig() {
            log('Checking current email configuration...');
            
            const configStatus = document.getElementById('configStatus');
            const configDisplay = document.getElementById('configDisplay');
            
            // Check if firebase-config.js is loaded
            if (typeof emailConfig === 'undefined') {
                configStatus.innerHTML = `
                    <div class="test-result error">
                        <strong>❌ Configuration Not Found</strong><br>
                        The emailConfig object is not loaded. Make sure firebase-config.js is properly included.
                    </div>
                `;
                log('Email configuration not found', 'error');
                return;
            }

            // Display current configuration (with password masked)
            const maskedConfig = {
                Host: emailConfig.Host,
                Username: emailConfig.Username,
                Password: emailConfig.Password ? '***HIDDEN***' : 'NOT SET',
                Port: emailConfig.Port,
                SecureToken: emailConfig.SecureToken
            };

            configDisplay.innerHTML = JSON.stringify(maskedConfig, null, 2);
            configDisplay.style.display = 'block';

            // Validate configuration
            let issues = [];
            
            if (!emailConfig.Username || !emailConfig.Username.includes('@gmail.com')) {
                issues.push('Username should be a valid Gmail address');
            }
            
            if (!emailConfig.Password || emailConfig.Password.length < 16) {
                issues.push('App password should be 16 characters long');
            }
            
            if (emailConfig.Host !== 'smtp.gmail.com') {
                issues.push('Host should be "smtp.gmail.com" for Gmail');
            }
            
            if (emailConfig.Port !== 587) {
                issues.push('Port should be 587 for Gmail SMTP');
            }

            if (issues.length === 0) {
                configStatus.innerHTML = `
                    <div class="test-result success">
                        <strong>✅ Configuration Looks Good</strong><br>
                        All required settings are present. If emails still don't work, try the test below.
                    </div>
                `;
                log('Email configuration appears valid');
            } else {
                configStatus.innerHTML = `
                    <div class="test-result warning">
                        <strong>⚠️ Configuration Issues Found:</strong><br>
                        ${issues.map(issue => `• ${issue}`).join('<br>')}
                    </div>
                `;
                log(`Configuration issues: ${issues.join(', ')}`, 'warning');
            }
        }

        async function testEmailWithCredentials() {
            const gmailUser = document.getElementById('testGmailUser').value.trim();
            const appPassword = document.getElementById('testAppPassword').value.trim().replace(/\s/g, '');
            const toEmail = document.getElementById('testToEmail').value.trim();
            
            if (!gmailUser || !appPassword || !toEmail) {
                showTestResult('error', 'Please fill in all fields');
                log('Missing required fields for email test', 'error');
                return;
            }

            log(`Testing email with credentials: ${gmailUser} -> ${toEmail}`);
            showTestResult('info', 'Sending test email...');

            try {
                const result = await Email.send({
                    Host: "smtp.gmail.com",
                    Username: gmailUser,
                    Password: appPassword,
                    Port: 587,
                    To: toEmail,
                    From: gmailUser,
                    Subject: "🧪 Email Test - Classroom Booking System",
                    Body: `
                        <h2>Email Test Successful! 🎉</h2>
                        <p>This is a test email from your Enhanced Classroom Booking System.</p>
                        <p><strong>Test Details:</strong></p>
                        <ul>
                            <li>From: ${gmailUser}</li>
                            <li>To: ${toEmail}</li>
                            <li>Time: ${new Date().toLocaleString()}</li>
                            <li>Service: SMTP.js via Gmail</li>
                        </ul>
                        <p>If you received this email, your email notifications are working correctly!</p>
                        <hr>
                        <small>Enhanced Classroom Booking System - Email Test</small>
                    `
                });

                if (result === "OK") {
                    showTestResult('success', `✅ Test email sent successfully! Check ${toEmail} for delivery.`);
                    log('Test email sent successfully');
                    
                    // Offer to update configuration
                    const updateConfig = confirm('Test email sent successfully! Would you like to update your firebase-config.js with these working credentials?');
                    if (updateConfig) {
                        generateUpdatedConfig(gmailUser, appPassword);
                    }
                } else {
                    throw new Error(`Email send failed: ${result}`);
                }

            } catch (error) {
                showTestResult('error', `❌ Email test failed: ${error.message}`);
                log(`Email test failed: ${error.message}`, 'error');
                
                // Provide specific troubleshooting
                if (error.message.includes('authentication') || error.message.includes('535')) {
                    showTestResult('warning', `
                        🔧 Authentication issue detected:<br>
                        • Double-check your app password<br>
                        • Make sure 2FA is enabled<br>
                        • Try generating a new app password<br>
                        • Ensure "Less secure apps" is OFF
                    `);
                } else if (error.message.includes('network') || error.message.includes('timeout')) {
                    showTestResult('warning', `
                        🌐 Network issue detected:<br>
                        • Check your internet connection<br>
                        • Try again in a few minutes<br>
                        • Consider using EmailJS as alternative
                    `);
                }
            }
        }

        async function testEmailWithCurrentConfig() {
            log('Testing email with current configuration...');
            
            if (typeof emailConfig === 'undefined') {
                showTestResult('error', '❌ Email configuration not loaded');
                log('Email configuration not loaded', 'error');
                return;
            }

            if (!emailConfig.Username || !emailConfig.Password) {
                showTestResult('error', '❌ Missing email credentials in configuration');
                log('Missing email credentials', 'error');
                return;
            }

            try {
                showTestResult('info', 'Sending test email with current configuration...');
                
                const result = await Email.send({
                    Host: emailConfig.Host,
                    Username: emailConfig.Username,
                    Password: emailConfig.Password,
                    Port: emailConfig.Port,
                    To: emailConfig.Username, // Send to self
                    From: emailConfig.Username,
                    Subject: "🧪 Configuration Test - Classroom Booking System",
                    Body: `
                        <h2>Configuration Test Successful! 🎉</h2>
                        <p>Your current email configuration is working correctly.</p>
                        <p><strong>Configuration Details:</strong></p>
                        <ul>
                            <li>Host: ${emailConfig.Host}</li>
                            <li>Port: ${emailConfig.Port}</li>
                            <li>Username: ${emailConfig.Username}</li>
                            <li>Secure: ${emailConfig.SecureToken}</li>
                        </ul>
                        <p>Email notifications should now work in your booking system.</p>
                        <hr>
                        <small>Enhanced Classroom Booking System - Configuration Test</small>
                    `
                });

                if (result === "OK") {
                    showTestResult('success', '✅ Current configuration works! Email notifications should be working in your booking system.');
                    log('Current configuration test successful');
                } else {
                    throw new Error(`Email send failed: ${result}`);
                }

            } catch (error) {
                showTestResult('error', `❌ Current configuration test failed: ${error.message}`);
                log(`Current configuration test failed: ${error.message}`, 'error');
            }
        }

        function showTestResult(type, message) {
            const resultDiv = document.getElementById('emailTestResult');
            resultDiv.innerHTML = `<div class="test-result ${type}" style="margin-top: 15px;">${message}</div>`;
        }

        function generateUpdatedConfig(username, password) {
            const updatedConfig = `
// Updated Email Configuration - Working Settings
const emailConfig = {
    Host: "smtp.gmail.com",
    Username: "${username}",
    Password: "${password}",
    Port: 587,
    SecureToken: true
};

// Update your teacher emails list as needed
const teacherEmails = [
    "${username}",
    // Add other teacher emails here
];
            `.trim();

            const blob = new Blob([updatedConfig], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'updated-email-config.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('Generated updated email configuration file');
            alert('Updated email configuration downloaded! Replace the relevant section in your firebase-config.js file.');
        }

        function setupEmailJS() {
            const instructions = `
            EmailJS Setup Instructions:
            
            1. Go to https://www.emailjs.com/
            2. Sign up for a free account
            3. Create an email service (Gmail, Outlook, etc.)
            4. Create an email template
            5. Get your User ID, Service ID, and Template ID
            6. Replace SMTP.js with EmailJS in your code
            
            EmailJS is more reliable and doesn't have the security issues of SMTP.js.
            `;
            
            alert(instructions);
            window.open('https://www.emailjs.com/', '_blank');
            log('Opened EmailJS setup instructions');
        }

        function showWebhookGuide() {
            const guide = `
            Webhook Email Solution:
            
            1. Create a Firebase Cloud Function or similar webhook
            2. Use server-side email libraries (Nodemailer, SendGrid, etc.)
            3. Call the webhook from your frontend
            4. This provides better security and reliability
            
            This is the most professional solution but requires server-side setup.
            `;
            
            alert(guide);
            log('Showed webhook guide');
        }

        function generateNoEmailVersion() {
            const noEmailCode = `
// Disable email notifications temporarily
window.sendEmailNotification = function(bookingData, isRecurring = false) {
    console.log('Email notification disabled:', bookingData);
    return Promise.resolve({ success: true, message: 'Email notifications disabled' });
};
            `.trim();

            const blob = new Blob([noEmailCode], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'disable-email-notifications.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Generated code to disable email notifications. Add this to your firebase-config.js to temporarily disable emails.');
            log('Generated no-email version');
        }

        function clearConsole() {
            document.getElementById('debugConsole').textContent = 'Console cleared.\n';
            debugLog = [];
        }

        function exportDebugLog() {
            const logContent = debugLog.join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `email-debug-log-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('Debug log exported');
        }

        // Auto-run configuration check on page load
        window.addEventListener('load', () => {
            log('Email debug tool loaded');
            
            // Try to load the firebase config
            const script = document.createElement('script');
            script.src = 'firebase-config.js';
            script.onload = () => {
                log('Firebase configuration loaded successfully');
                setTimeout(checkCurrentConfig, 1000);
            };
            script.onerror = () => {
                log('Failed to load firebase-config.js', 'error');
                document.getElementById('configStatus').innerHTML = `
                    <div class="test-result error">
                        <strong>❌ Cannot Load Configuration</strong><br>
                        Make sure firebase-config.js exists and is accessible.
                    </div>
                `;
            };
            document.head.appendChild(script);
        });
    </script>
</body>
</html>